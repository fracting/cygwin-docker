build:
  image: teaci/wine-staging
  commands:
    - wget http://security.ubuntu.com/ubuntu/pool/main/f/freetype/libfreetype6_2.5.2-1ubuntu2_i386.deb && wget http://security.ubuntu.com/ubuntu/pool/main/f/freetype/libfreetype6_2.5.2-1ubuntu2_amd64.deb && dpkg -i libfreetype6_2.5.2-1ubuntu2_amd64.deb libfreetype6_2.5.2-1ubuntu2_i386.deb
    - export WINPTY_SHOW_CONSOLE=1
    - agt-get install -y attr

    - cp cygwin-env /etc
    - cp cygwin-shell /usr/bin
    - cp cygwin-rebase /usr/bin
    - cp cygwin-init /usr/bin
    - cp cygwin32 /usr/bin
    - cp cygwin64 /usr/bin

# unset DRONE to skip copying wineprefix in cygwin-init
    - DRONE=false WINEPREFIX=`pwd`/wineprefix CYGWIN_ARCH=$$arch cygwin-init
    - getfattr wineprefix/drive_c/cygwin*/dev/fd
    

publish:
  docker:
    file: Dockerfile
    username: $$DOCKER_USER
    password: $$DOCKER_PASS
    email: $$DOCKER_EMAIL
    repo: teaci/cygwin$$arch
    tag:
      - "latest"
    when:
      repo: fracting/cygwin-docker
      branch: ["master", "cygwin-debug"]

matrix:
  arch:
    - 64
    - 32
